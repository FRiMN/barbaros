name: Build Flatpak and flatpakref

on:
  release:
    types: [published]

jobs:
  build:
    name: Build and Publish Flatpak
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        run: |
          pip install build

      - name: Build Python wheel
        run: |
          python -m build --wheel

      - name: Install Flatpak
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub repository
        run: flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Extract version from tag
        id: version
        run: |
          # Удаляем 'refs/tags/' и, при необходимости, 'v' в начале
          VERSION=$(echo "${GITHUB_REF#refs/tags/}" | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Tag version: $VERSION"

      - name: Build Flatpak bundle
        run: |
          # Создаём каталог для репозитория
          mkdir repo
          # Собираем приложение
          flatpak-builder \
            --repo=repo \
            --force-clean \
            --install-deps \
            build-dir \
            flatpak/io.github.frimn.barbaros.yml
          # Создаём .flatpak файл
          flatpak build-bundle repo barbaros-${{ env.VERSION }}.flatpak io.github.frimn.barbaros

      - name: Upload .flatpak to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: barbaros-${{ env.VERSION }}.flatpak
          asset_name: barbaros-${{ env.VERSION }}.flatpak
          tag: ${{ github.ref }}
          overwrite: true

      - name: Generate .flatpakref
        run: |
          cat > barbaros-${{ env.VERSION }}.flatpakref << EOF
          [Flatpak Ref]
          Title=Barbaros
          Name=io.github.frimn.barbaros
          Branch=stable
          Url=https://github.com/frimn/barbaros/releases/download/${{ github.ref_name }}/barbaros-${{ env.VERSION }}.flatpak
          IsRuntime=false
          Sdk=org.kde.Sdk
          EOF

      - name: Upload .flatpakref to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: barbaros-${{ env.VERSION }}.flatpakref
          asset_name: barbaros-${{ env.VERSION }}.flatpakref
          tag: ${{ github.ref }}
          overwrite: true
